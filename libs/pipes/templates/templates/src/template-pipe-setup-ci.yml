steps:
  - checkout: self
    displayName: Checkout repo on pipeline agent
    persistCredentials: true
    clean: true
    lfs: true
    submodules: true
    fetchTags: true
    fetchDepth: 0
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Install Node.js'
  - task: Cache@2
    inputs:
      key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
      path: $(Pipeline.Workspace)/.pnpm-store
    displayName: Cache pnpm
  - script: |
      corepack enable
      corepack prepare pnpm@latest-8 --activate
      pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
    displayName: 'Setup pnpm'
  - task: CmdLine@2
    displayName: Install Dependencies and config git user
    continueOnError: true
    inputs:
      script: |
        pnpm install
        pnpm setup-ci
        git config --global user.name "Pipeline Agent"
        git config --global user.email "pipelines@aiviagroup.com"
